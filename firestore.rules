rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isStringBetween(value, minLen, maxLen) {
      return value is string && value.size() >= minLen && value.size() <= maxLen;
    }

    function isOptionalString(value, maxLen) {
      return !(value is string) || value.size() <= maxLen;
    }

    function isTimestamp(value) {
      return value is timestamp;
    }

    // Forum boards
    match /forumBoards/{boardId} {
      allow read: if true;
      allow create, update, delete: if isSignedIn();
    }

    // Forum topics
    match /forumTopics/{topicId} {
      allow read: if true;
      allow create, update, delete: if isSignedIn();
    }

    // Forum posts (yorumlar)
    match /forumPosts/{postId} {
      allow read: if true;

      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly([
          "boardId",
          "topicId",
          "authorUid",
          "authorName",
          "authorAvatar",
          "body",
          "createdAt",
          "likes",
          "reactions",
          "viewCount",
          "replyTo",
          "attachmentUrl"
        ])
        && isStringBetween(request.resource.data.boardId, 1, 200)
        && isStringBetween(request.resource.data.topicId, 1, 200)
        && request.resource.data.authorUid == request.auth.uid
        && isStringBetween(request.resource.data.authorName, 2, 120)
        && isOptionalString(request.resource.data.authorAvatar, 8)
        && isStringBetween(request.resource.data.body, 1, 2000)
        && isOptionalString(request.resource.data.attachmentUrl, 1000)
        && request.resource.data.likes == 0
        && isTimestamp(request.resource.data.createdAt)
        && request.resource.data.createdAt == request.time;

      allow update: if isSignedIn()
        && (
          // Yazar kendi gönderisini güncelleyebilir
          (request.auth.uid == resource.data.authorUid
            && request.resource.data.keys().hasOnly([
              "boardId",
              "topicId",
              "authorUid",
              "authorName",
              "authorAvatar",
              "body",
              "createdAt",
              "likes",
              "reactions",
              "viewCount",
              "replyTo",
              "attachmentUrl"
            ])
            && request.resource.data.boardId == resource.data.boardId
            && request.resource.data.topicId == resource.data.topicId
            && request.resource.data.authorUid == resource.data.authorUid
            && request.resource.data.authorName == resource.data.authorName
            && request.resource.data.authorAvatar == resource.data.authorAvatar
            && request.resource.data.createdAt == resource.data.createdAt
            && request.resource.data.likes == resource.data.likes
            && isStringBetween(request.resource.data.body, 1, 2000)
            && isOptionalString(request.resource.data.attachmentUrl, 1000))
          ||
          // Herkes reaksiyon ekleyip çıkarabilir (sadece reactions alanı değişebilir, diğer alanlar aynı kalmalı)
          (request.resource.data.reactions is map
            && request.resource.data.boardId == resource.data.boardId
            && request.resource.data.topicId == resource.data.topicId
            && request.resource.data.authorUid == resource.data.authorUid
            && request.resource.data.authorName == resource.data.authorName
            && request.resource.data.authorAvatar == resource.data.authorAvatar
            && request.resource.data.body == resource.data.body
            && request.resource.data.createdAt == resource.data.createdAt
            && request.resource.data.likes == resource.data.likes
            && request.resource.data.viewCount == resource.data.viewCount)
          ||
          // Herkes görüntülenme sayısını artırabilir (sadece viewCount değişebilir, diğer alanlar aynı kalmalı)
          (request.resource.data.viewCount is int
            && request.resource.data.viewCount >= resource.data.viewCount
            && request.resource.data.boardId == resource.data.boardId
            && request.resource.data.topicId == resource.data.topicId
            && request.resource.data.authorUid == resource.data.authorUid
            && request.resource.data.authorName == resource.data.authorName
            && request.resource.data.authorAvatar == resource.data.authorAvatar
            && request.resource.data.body == resource.data.body
            && request.resource.data.createdAt == resource.data.createdAt
            && request.resource.data.likes == resource.data.likes
            && request.resource.data.reactions == resource.data.reactions)
        );

      allow delete: if isSignedIn() && (request.auth.uid == resource.data.authorUid || isAdmin());
    }

    // Follow relationships scoped by user
    match /userFollows/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // Metadata collections restricted to admins
    match /forumMeta/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /forumEvents/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /forumModerators/{moderatorId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // User settings scoped by UID
    match /userSettings/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // User profiles
    match /userProfiles/{userId} {
      allow read: if true; // Herkes okuyabilir (kullanıcı adlarını göstermek için)
      allow create: if isSignedIn() 
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(["username", "displayName", "email"])
        && isStringBetween(request.resource.data.username, 3, 20)
        && isStringBetween(request.resource.data.displayName, 2, 120)
        && isStringBetween(request.resource.data.email, 5, 200);
      allow update: if isSignedIn() 
        && request.auth.uid == userId
        && resource.data.username == request.resource.data.username // username değiştirilemez
        && resource.data.email == request.resource.data.email // email değiştirilemez
        && isStringBetween(request.resource.data.displayName, 2, 120);
    }

    // Notifications
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if isSignedIn()
        && request.resource.data.keys().hasAll(["userId", "type", "actorUid", "actorName", "read", "createdAt"])
        && request.resource.data.userId is string
        && request.resource.data.type is string
        && request.resource.data.actorUid == request.auth.uid
        && isStringBetween(request.resource.data.actorName, 2, 120)
        && request.resource.data.read == false;
      allow update: if isSignedIn()
        && request.auth.uid == resource.data.userId
        && request.resource.data.keys().hasOnly(["read"])
        && request.resource.data.read == true;
    }
  }
}
